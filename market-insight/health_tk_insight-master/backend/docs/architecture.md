# 架构决策记录 (Architecture Decision Records)

## 概述

本文档记录项目中的关键架构决策及其背后的理由，便于团队理解设计意图和后续维护。

---

## ADR-001: 使用 LangGraph 作为 Agent 框架

**日期**: 2026-02-02  
**状态**: 已采纳

### 背景
需要选择一个 Agent 编排框架来管理报告生成的工作流。

### 决策
选择 LangGraph 作为 Agent 编排框架。

### 理由
1. **状态机模型**: LangGraph 基于状态图，天然适合多步骤工作流
2. **可视化**: 支持工作流可视化，便于调试
3. **灵活性**: 支持条件分支、循环、并行执行
4. **生态**: 与 LangChain 生态良好集成

### 替代方案考虑
- **LangChain Agents**: 过于复杂，不适合确定性工作流
- **自定义管道**: 开发成本高，缺乏标准化

---

## ADR-002: 采用异步任务队列模式

**日期**: 2026-02-02  
**状态**: 已采纳

### 背景
报告生成耗时较长（30s-2min），需要处理长时任务。

### 决策
采用异步任务队列模式：
1. 用户提交请求 → 返回 task_id
2. 后台异步执行任务
3. 前端轮询获取结果

### 理由
1. **避免超时**: HTTP 请求不会因任务耗时而超时
2. **用户体验**: 用户可实时查看进度
3. **可扩展**: 支持任务重试、优先级调度
4. **解耦**: 任务执行与 API 服务解耦

### 实现
- 开发阶段: FastAPI BackgroundTasks
- 生产阶段: Celery + Redis

---

## ADR-003: 报告直接返回 HTML 内容

**日期**: 2026-02-02  
**状态**: 已采纳

### 背景
需要确定报告的存储和交付方式。

### 决策
后端生成自包含 HTML 报告，并通过专用下载端点以 `text/html` 文件流交付；任务状态接口仅返回 `report_url`，不存储到对象存储。

### 理由
1. **职责分离**: 后端专注生成，前端负责存储展示
2. **简化架构**: 无需对象存储服务
3. **灵活性**: 前端可自行决定存储方式
4. **更稳健的交付**: 避免将大段 HTML 嵌入 JSON（体积/转义/安全处理成本更高）

### 权衡
- 优点: 架构简单，依赖少
- 缺点: 前端需要在 `completed` 后再请求一次下载端点获取报告内容

---

## ADR-004: 使用 SVG 生成静态图表

**日期**: 2026-02-02  
**状态**: 已采纳

### 背景
报告中需要包含数据图表。

### 决策
使用 SVG 格式，由后端动态生成图表。

### 理由
1. **静态性**: 无需 JavaScript 运行环境
2. **便携性**: 报告完全自包含，可离线查看
3. **打印友好**: SVG 支持高质量打印
4. **控制力**: 完全控制图表样式

### 替代方案考虑
- **ECharts/Chart.js**: 需要 JS 环境
- **后端截图**: 需要浏览器依赖，复杂度高

---

## ADR-005: 数据源抽象层设计

**日期**: 2026-02-02  
**状态**: 已采纳

### 背景
需要集成多个外部数据源（Tavily、小红书、抖音）。

### 决策
设计 BaseDataSource 抽象基类，所有数据源继承该类。

### 理由
1. **统一接口**: 所有数据源使用相同的调用方式
2. **易于扩展**: 新增数据源只需实现接口
3. **降级处理**: 可统一处理数据源不可用的情况
4. **测试友好**: 可轻松替换为 Mock 实现

### 接口定义
```python
class BaseDataSource:
    async def search(query: str, **kwargs) -> List[Dict]
    async def get_detail(item_id: str, **kwargs) -> Dict
    async def check_availability() -> bool
```

---

## ADR-006: 使用 Pydantic 进行数据验证

**日期**: 2026-02-02  
**状态**: 已采纳

### 背景
API 需要处理用户输入和复杂的数据结构。

### 决策
使用 Pydantic 进行请求/响应模型定义和数据验证。

### 理由
1. **类型安全**: 编译时发现类型错误
2. **自动验证**: FastAPI 集成，自动验证请求
3. **文档生成**: 自动生成 OpenAPI 文档
4. **序列化**: 内置 JSON 序列化支持

---

## ADR-007: 模板维护策略

**日期**: 2026-02-02  
**状态**: 已采纳

### 背景
HTML 报告模板需要有维护和更新机制。

### 决策
模板文件存储在 `app/templates/` 目录，使用 Jinja2 语法。

### 理由
1. **版本控制**: 模板与代码一起版本管理
2. **Jinja2**: 成熟的模板引擎，与 FastAPI 良好集成
3. **分离关注点**: 内容生成与模板渲染分离

### 模板结构
- 保持与参考 HTML 一致的 DOM 结构
- CSS 内联，保证自包含
- 使用 Jinja2 占位符标记动态内容

---

## 后续决策

以下决策待进一步讨论：

1. **缓存策略**: 是否需要缓存 API 响应？
2. **限流方案**: 如何限制并发任务数？
3. **多语言支持**: 报告是否需要支持多语言？
4. **PDF 导出**: 是否需要支持 PDF 格式？

---

_本文档随项目演进持续更新_
